<!DOCTYPE html>
<html>
    <head>
        <title>Changing the WhatsApp group colors</title>
        <link rel="stylesheet" href="stylesheets/style.css" type="text/css" />
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    </head>
    <body>
        <header>
            <h1>Group Name Color</h1>
        </header>
        <nav>
            <a id="nav" href="#nav" class="menubtn"></a>
            <div class="hamburger"></div>
            <div class="menu">
                <h2><a href="#home">Navigation</a></h2>
                <ul>
                    <li><a href="/#screens">Screenshots</a></li>
                    <li><a href="/#downloads">Downloads</a></li>
                    <li><a href="/#changelog">Changelog</a></li>
                    <li><a href="/#source">Source Code</a></li>
                    <li><a href="/#credits">Credits</a></li>
                    <li><a href="#">Group Name Color</a>
                        <ul>
                            <li><a href="#findingit">Finding the file</a></li>
                            <li><a href="#changingit">Changing the colors</a></li>
                        </ul>
                    </li>
                </ul>
                <p>Website by David Leppla-Weber</p>
            </div>
        </nav>
        <div class="wrapper">
            <a href="#findingit"><h2>How I Found The File</h2></a>
            <section>
                <div class="content" id="findingit">
                    <h3>TL;DR</h3>
                    <p>Open smali/com/whatsap/rb.smali in the text editor of your choice and replace the hex codes starting at line 1298 with your preferred colors.</p>
                    <p>
                        The first question I asked myself was: "what am I actually looking for?" Most of you would probably say "for the place where the text color is set of course". While this isn't wrong, it's not really precise.
                        More precise would be: "I'm looking for a call to setTextColor on a TextView object."<br />
                        So I used one of the goodies coming with git (if you don't use/know that, you really should try it out, it's an awesome tool and as WAMD is hosted on github it makes sense to use it), namely git grep to search for <code>setTextColor</code>.
                        Of course there were a lot of results because that really isn't the most fine-grained query, but one of the first files sounded interesting,
                        ConversationRow.smali (I'll be in smali/com/whatsapp the whole time incase you wonder about the directory).
                        So I opened that file and simply looked for the first call to <code>setTextColor</code>.
                        In smali, it looked like that:
                    </p>
<pre><code>.line 84
if-eqz v3, :cond_8

.line 26
iget v3, v3, Lcom/whatsapp/w_;-&gt;a:I

invoke-virtual {v0, v3}, Landroid/widget/TextView;-&gt;setTextColor(I)V</code></pre>
                    <p>
                        That basically means, if some condition is (not) met, get an integer from a class and call <code>setTextColor</code> with that integer as parameter on some object. That's good, sounds like it could be our group member name color.
                        To be 100% sure I removed the line calling <code>setTextColor</code> and guess what, all group names went black.
                    </p>
                    <p>
                        Now we know where the color is set but we need to know where it came from.<br />
                        So let's take a look at w_.smali, where we got that mysterious <code>a</code> from. If you open it you'll see the <code>a</code> directly in line 7, but there it is only declared and not set.
                        We're looking for the place where it is set. As a quick search for <code>iput&nbsp;</code> (used to set an integer) yielded nothing I closed the file and used git grep to look for <code>w_;-&gt;a;</code>,
                        that's how you access the member of a class in smali. That led me to x.smali, the only file calling iput on this object (remember, that sets an integer). It did this in two functions, one called a() and one c().
                        One of these calls to iput looked like that:
                    </p>
<pre><code>invoke-static {}, Lcom/whatsapp/rb;-&gt;a()[I

move-result-object v5

array-length v5, v5

rem-int v5, v1, v5

aget v4, v4, v5

iput v4, v0, Lcom/whatsapp/w_;-&gt;a:I</code></pre>
                    <p>
                        That's interesting, because the <code>a()[I</code> means that it gets an array of integers from <code>rb</code>. Then it sets <code>w_;-&gt;a</code> to one of these values.
                        Remember, this <code>a</code> is the value later used for one of the group name colors. So we're pretty close.
                    </p>
                    <p>
                        Let's take a look at this <code>rb;-&gt;a()</code> function. This function is actually pretty short and straight forward:
                    </p>
<pre><code>.method static a()[I
.locals 1

.prologue
.line 255
sget-object v0, Lcom/whatsapp/rb;-&gt;f:[I

return-object v0
.end method</code></pre>
                <p>
                    It's a simple getter for the member variable <code>f</code>, an array of integers. So I looked for other usages of that variable and that's what I found:
                </p>
<pre><code>fill-array-data v0, :array_0

sput-object v0, Lcom/whatsapp/rb;-&gt;f:[I</code></pre>
                <p>
                    Straight forward as well, it takes the values from <code>array_0</code> and fills <code>f</code> with that. A quick search for <code>array_0</code> and there we are, line 1296:
                </p>
<pre><code>:array_0
.array-data 4
    -0x4b38b5
    -0x7c6c36
    -0x8fd4
    -0xb14445
    -0x2049f0
    -0xe08514
    -0xf6e47
    -0xfd6300
    -0x879640
    -0x4b7892
    -0x18381
    -0xa62c98
    -0x5686
    -0x82610f
    -0x36fc87
    -0x5c1d35
    -0x59bfd4
    -0x1abd5d
    -0x5e9053
    -0x10b4b1</code></pre>
                    <p>
                        Finally, we found the color values for the group names :D<br />Now we just need to know how to change them...
                    </p>
                </div>
            </section>
            <a href="#changingit"><h2>Changing The Colors</h2></a>
            <section>
                <div class="content" id="changingit">
                    <p>
                        Just changing the colors is actually pretty easy. You remove the existing colors and for every color you add a new one in that format: <code>0x8digithexcode</code><br />
                        Therefore white looks like that: <code>0xffffffff</code>, red like that: <code>0xffff0000</code> etc. Simple color hex codes. The first two digits are the alpha part, the second two the red part, the third the green and the fourth the blue.
                    </p>
                    <p>
                        But what if we just want to change one specific color? Then we have to know which existing hex code corresponds to that. You may have noticed that there is a minus sign before every color in the smali file.
                        This minus tells the computer to build the <a target="_blank" href="http://en.wikipedia.org/wiki/Two%27s_complement">Two's Complement</a> of the number.
                        Basically it flips all bits and then adds 1. That's how substraction works on computers, 7 - 5 is calculated as 7 + TwosComplement(5).
                        Sounds like magic, but it works. You don't believe me? Here's an example.
                    </p>
                    <p>
                        Say you want to calculate 7 - 5. 7 in bits is 0111, 5 is 0101. The first bit is the sign bit, 1 means the number is negative.
                        Now we build the ones' complement of 5 by flipping the bits, resulting in 1010, and the two's complement by adding one to it, yielding to 1011.<br />
                        Let's add the two numbers like we did in elementary school:
                    </p>
<pre><code>
 0111 # 7
+1011 # two's complement of 5
-----
=0010 # 2</code></pre>
                    <p>
                        Believe me now? No? Bad for you.
                    </p>
                    <p>
                        So how do we get this two's complement?<br />
                        An integer in Java has 32 bits, you don't want to do that manually. But good news, there's another way doing it. The two's complement of a number x is also defined as 2<sup>N</sup> - x,
                        being N the number of bits of x. 2<sup>N</sup> in binary is the same as 1 shifted N times to the left. 1 is 2<sup>0</sup>, 10<sub>2</sub> (2) is 2<sup>1</sup>, 100<sub>2</sub> (4) is 2<sup>2</sup> etc.
                        Shifting a value in python can be done by using the <code>&lt;&lt;</code> operator so a function calculating the two's complement could look like that:
                    </p>
<pre><code>
def twosComplement(number, bits):
    return (1 &lt;&lt; bits) - number</code></pre>
                    <p>
                        A oneliner to directly print the resulting hex code would be (remember that an integer in java has 32 bits):
                    </p>
                        <pre><code>print('{0x:X}'.format((1 &lt;&lt; 32) - hexfromsmali))</code></pre>
                    <p><br />
                        Doing
                    </p>
                    <pre><code>print('0x{:X}'.format((1 &lt;&lt; 32) - 0x4b38b5))</code></pre>
                    <p>for example yields <span style="color:#b4c74b">0xFFB4C74B</span>. You know that color from somewhere? To me it looks like a group name color which I see very often in WhatsApp groups ;)<br />
                        Well, because I'm nice I did all the dirty work for you, here are all the two's complements of the numbers:
                    </p>
<pre><code>-0x4b38b5: <span style="color:#B4C74B">0xFFB4C74B</span>
-0x7c6c36: <span style="color:#8393CA">0xFF8393CA</span>
-0x8fd4:   <span style="color:#FF702C">0xFFFF702C</span>
-0xb14445: <span style="color:#4EBBBB">0xFF4EBBBB</span>
-0x2049f0: <span style="color:#DFB610">0xFFDFB610</span>
-0xe08514: <span style="color:#1F7AEC">0xFF1F7AEC</span>
-0xf6e47:  <span style="color:#F091B9">0xFFF091B9</span>
-0xfd6300: <span style="color:#029D00">0xFF029D00</span>
-0x879640: <span style="color:#7869C0">0xFF7869C0</span>
-0x4b7892: <span style="color:#B4876E">0xFFB4876E</span>
-0x18381:  <span style="color:#FE7C7F">0xFFFE7C7F</span>
-0xa62c98: <span style="color:#59D368">0xFF59D368</span>
-0x5686:   <span style="color:#FFA97A">0xFFFFA97A</span>
-0x82610f: <span style="color:#7D9EF1">0xFF7D9EF1</span>
-0x36fc87: <span style="color:#C90379">0xFFC90379</span>
-0x5c1d35: <span style="color:#A3E2CB">0xFFA3E2CB</span>
-0x59bfd4: <span style="color:#A6402C">0xFFA6402C</span>
-0x1abd5d: <span style="color:#E542A3">0xFFE542A3</span>
-0x5e9053: <span style="color:#A16FAD">0xFFA16FAD</span>
-0x10b4b1: <span style="color:#EF4B4F">0xFFEF4B4F</span></code></pre>
                </div>
            </section>
    </body>
</html>
